<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Datasheet Finder</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .result-item, .gemini-feature { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .gemini-button {
            background-color: #8e44ad; /* A purple color for Gemini features */
            color: white;
        }
        .gemini-button:hover {
            background-color: #9b59b6;
        }
        .gemini-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen py-8">

    <div class="w-full max-w-2xl mx-auto p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
            <div class="flex items-center justify-center mb-6">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="text-blue-500 mr-3" viewBox="0 0 16 16">
                    <path d="M4 0a4 4 0 0 0-4 4v8a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4V4a4 4 0 0 0-4-4H4Zm5.5 1.5h1a.5.5 0 0 1 .5.5V3h-2V2a.5.5 0 0 1 .5-.5ZM4.5 1.5h1a.5.5 0 0 1 .5.5V3h-2V2a.5.5 0 0 1 .5-.5ZM10 5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1V5ZM6 5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V5ZM2 5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5Zm1 5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1Zm4 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-1Zm4 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-1Z"/>
                </svg>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white text-center">AI Datasheet Finder</h1>
            </div>
            
            <div class="flex items-center space-x-2 mb-6">
                <input type="text" id="componentInput" class="flex-grow bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg px-4 py-2.5 text-base transition" placeholder="e.g., NE555, ATmega328P...">
                <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-5 py-2.5 transition shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Find
                </button>
            </div>

            <div id="resultsDisplay" class="space-y-3"></div>
            
            <!-- Gemini Features Section -->
            <div id="geminiSection" class="mt-6 hidden">
                 <button id="projectIdeasBtn" class="gemini-button w-full font-semibold rounded-lg px-5 py-2.5 transition shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                    ✨ Generate Project Ideas
                </button>
                <div id="projectIdeasDisplay" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-800 dark:text-gray-200 text-sm leading-relaxed"></div>
            </div>

        </div>
        <p class="text-center text-gray-500 dark:text-gray-400 text-sm mt-4">Powered by Google Search & Gemini API</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const serpApiKey = "521c8e6d1a77a6188d323160426b96bcbec811a630d5b3e8ed7a3ee0475a1ee9";
        const geminiApiKey = ""; // Leave empty to use the provided key

        // --- DOM ELEMENTS ---
        const componentInput = document.getElementById('componentInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsDisplay = document.getElementById('resultsDisplay');
        const geminiSection = document.getElementById('geminiSection');
        const projectIdeasBtn = document.getElementById('projectIdeasBtn');
        const projectIdeasDisplay = document.getElementById('projectIdeasDisplay');

        // --- EVENT LISTENERS ---
        searchBtn.addEventListener('click', findDatasheets);
        componentInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') findDatasheets();
        });
        projectIdeasBtn.addEventListener('click', getProjectIdeas);
        
        // Use event delegation for dynamically created summarize buttons
        resultsDisplay.addEventListener('click', function(event) {
            if (event.target && event.target.matches('.summarize-btn')) {
                const button = event.target;
                const componentName = button.dataset.component;
                const summaryContainer = button.closest('.result-item').querySelector('.summary-container');
                getSummary(componentName, summaryContainer, button);
            }
        });

        // --- API CALLS ---
        
        /**
         * Calls the Gemini API with a given prompt.
         * Implements exponential backoff for retries.
         */
        async function callGemini(prompt, maxRetries = 3) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0]) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from Gemini API.");
                    }
                } catch (error) {
                    console.error(`Gemini API call attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error; // Rethrow last error
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                }
            }
        }

        /**
         * Searches for datasheets using SerpApi.
         */
        async function findDatasheets() {
            const componentName = componentInput.value.trim();
            if (!componentName) {
                displayMessage("Please enter a component name.", "text-yellow-500");
                return;
            }

            displayMessage("Searching for datasheets...", "text-gray-500");
            geminiSection.classList.add('hidden'); // Hide Gemini section on new search
            projectIdeasDisplay.innerHTML = '';

            const query = `${componentName} datasheet filetype:pdf`;
            const proxyUrl = 'https://api.allorigins.win/get?url=';
            const apiUrl = `https://serpapi.com/search.json?q=${encodeURIComponent(query)}&api_key=${serpApiKey}`;

            try {
                const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
                if (!response.ok) {
                    throw new Error(`Network response error from proxy: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();

                if (!data.contents) {
                    throw new Error("Proxy service did not return any content. It might be down or rate-limiting.");
                }

                const searchResults = JSON.parse(data.contents);

                if (searchResults.error) {
                    throw new Error(`SerpApi Error: ${searchResults.error}`);
                }

                const organicResults = searchResults.organic_results || [];
                displayResults(organicResults.slice(0, 5), componentName);
                
                if (organicResults.length > 0) {
                    geminiSection.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error fetching data:", error);
                displayMessage(`Error: ${error.message}. Check your API key and network connection. The proxy service may also be temporarily unavailable.`, "text-red-500");
            }
        }

        // --- GEMINI FEATURES ---

        async function getSummary(componentName, container, button) {
            button.disabled = true;
            container.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">✨ Summarizing with Gemini...</p>`;
            
            const prompt = `In 3 concise bullet points, what are the key features and typical applications of the electronic component "${componentName}"?`;

            try {
                const summary = await callGemini(prompt);
                // Simple formatting for the response
                const formattedSummary = summary
                    .replace(/\*/g, '•') // Replace asterisks with bullets
                    .split('\n')
                    .map(line => `<p>${line}</p>`)
                    .join('');
                container.innerHTML = `<div class="mt-2 p-3 bg-purple-50 dark:bg-gray-600 rounded-md">${formattedSummary}</div>`;
            } catch (error) {
                container.innerHTML = `<p class="text-sm text-red-500">Could not generate summary.</p>`;
                button.disabled = false; // Re-enable on error
            }
        }

        async function getProjectIdeas() {
            const componentName = componentInput.value.trim();
            if (!componentName) return;

            projectIdeasDisplay.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">✨ Brainstorming projects with Gemini...</p>`;
            
            const prompt = `Generate 3 simple and creative project ideas for an electronics student using a "${componentName}". For each project, provide a title, a one-sentence description, and a short list of the main components needed. Format the output clearly.`;

            try {
                const ideas = await callGemini(prompt);
                // Simple formatting for the response
                 const formattedIdeas = ideas
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-purple-600 dark:text-purple-400">$1</strong>') // Bold text
                    .replace(/\*/g, '•')
                    .replace(/\n/g, '<br>');
                projectIdeasDisplay.innerHTML = formattedIdeas;
            } catch (error) {
                projectIdeasDisplay.innerHTML = `<p class="text-sm text-red-500">Could not generate project ideas.</p>`;
            }
        }

        // --- UI DISPLAY FUNCTIONS ---

        function displayResults(results, componentName) {
            resultsDisplay.innerHTML = ''; 

            const pdfResults = results.filter(item => item.link.toLowerCase().endsWith('.pdf'));

            if (pdfResults.length === 0) {
                displayMessage("No direct PDF datasheets found. Try a different component name.", "text-gray-500");
                return;
            }

            pdfResults.forEach(item => {
                const { title, link, snippet } = item;
                const resultElement = `
                    <div class="result-item bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <a href="${link}" target="_blank" rel="noopener noreferrer" class="block hover:bg-gray-100 dark:hover:bg-gray-600 -m-4 p-4 rounded-lg transition">
                            <h3 class="font-semibold text-blue-600 dark:text-blue-400 truncate">${title}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 truncate">${snippet || 'No description available.'}</p>
                            <p class="text-xs text-green-600 dark:text-green-400 mt-2 truncate">${link}</p>
                        </a>
                        <div class="mt-3 border-t border-gray-200 dark:border-gray-600 pt-3">
                            <button class="summarize-btn gemini-button text-xs font-semibold rounded-md px-3 py-1.5 transition" data-component="${componentName}">✨ Summarize</button>
                            <div class="summary-container text-sm text-gray-700 dark:text-gray-200"></div>
                        </div>
                    </div>
                `;
                resultsDisplay.innerHTML += resultElement;
            });
        }

        function displayMessage(message, colorClass) {
            resultsDisplay.innerHTML = `<p class="${colorClass} text-center">${message}</p>`;
        }
    </script>
</body>
</html>
